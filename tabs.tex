
\newcommand{\rowcount}      {6}
\newcommand{\barwidth}      {4}
\newcommand{\stringheight}  {1.05}
\newcommand{\stringNames}   {{"e", "B", "G", "D", "A", "E"}}

% length of a bar, beats per bar
\NewDocumentEnvironment{tab}{mm}{%
  \vfill\begin{center}%
    \usetikzlibrary{calc}%
    \begin{optional}{tikzpicture}[scale=0.25, inner sep=0pt]%
      \setglobal{\totalbeatcount}{0}
      \setglobal{\barwidth}{#1} % width of a bar
      \setglobal{\beatcount}{#2} % number of beats in whole bar
      \setglobal{\beatstart}{0}
      \setglobal{\basebeatwidth}{\barwidth * \barwidth / \beatcount}
      \setglobal{\beatend}{\beatstart}
      \tabstart
      \barline
}{%
    \end{optional}
  \end{center}%
}

\NewDocumentCommand{\tabstart}{}{
  \foreach \row in {1,...,\rowcount}{
    \draw (-\barwidth * 0.25, \row * \stringheight) node {\scriptsize\pgfmathparse{\stringNames[6 - \row ]}\pgfmathresult};
  };
}

\NewDocumentCommand{\barline}{}{%
  \draw [thick] (\beatstart, \stringheight) -- (\beatstart, \rowcount * \stringheight);}


\NewDocumentCommand{\setglobal}{mm}{\pgfmathparse{#2}\global\edef#1{\pgfmathresult}}

\NewDocumentCommand{\barcomment}{m}{}
%\NewDocumentCommand{\tabdots}{}{
%  \setglobal{\barenter}{\beatend + \barwidth * 0.5}
%
%  \draw  (\barcenter, 3.5 * \stringheight) node {\ldots};
%  \setglobal{\totalbarwidth}{\totalbarcount + 1}
%  
%  \setglobal{\barstart}{\barend + \barwidth}
%  \setglobal{\barend}{\barstart}
%  \setglobal{\beatstart}{\barstart}
%  \barline
%}

\NewDocumentCommand{\emptybeat}{O{1}}{\tabbeat*[#1]{ , , , , , }}

% if currentchord should be used, base beat count multiplier (for fractions), frets
\NewDocumentCommand{\tabbeat}{sO{1}m}{
  \setglobal{\beatwidth}{\basebeatwidth * #2}

  % draw string lines for this beat
  \foreach \row in {1,...,\rowcount}{
    \draw (\beatstart, \row * \stringheight) -- (\beatstart + \beatwidth, \row * \stringheight);
  };

  \readlist*\notelist{#3}

  \foreach \row in {1,...,\rowcount}{
    \setglobal{\stringY}{(\rowcount - \row + 1) * \stringheight}
    \itemtomacro\notelist[\rowcount - \row + 1]\currnote
      \IfInteger{\currnote}{\draw (\beatstart + \beatwidth / 2, \stringY) node[circle, fill=white, scale = 0.6, inner sep=1pt] {\IfBooleanTF{#1}{\currentchord[\rowcount - \row + 1]}{\currnote}};}{}
  }

  \setglobal{\beatend}{\beatstart + \beatwidth}
  \setglobal{\beatstart}{\beatend}
}

\NewDocumentCommand{\setchord}{m}{\readlist*\currentchord{#1}}

% (bar divisions, division index), name 
%\NewDocumentCommand{\barcomment}{O{1,1}m}{
%  \readlist*\commentposition{#1}
%
%  \setglobal{\stepshift}{\barwidth * \barwidth / \commentposition[1]}
%  \setglobal{\commentstart}{\beatstart + (\stepshift * (\commentposition[2] - 0.5))}
%
%  \draw (\commentstart, -\stringheight * 0.75) node {\footnotesize\writechord{#2}};
%}

