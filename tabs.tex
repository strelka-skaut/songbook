
\newcommand{\tabrows}{6}

\newcommand{\barwidth}{4}
\newcommand{\stringheight}{1.05}

\newcounter{barindex}
\newcounter{totalbarcount}
\newcounter{barcount}

\NewDocumentCommand{\tabdots}{}{
  \pgfmathsetmacro{\barstart}{\value{totalbarcount} * \barwidth}
  \pgfmathsetmacro{\barcenter}{(\value{totalbarcount} * \barwidth) + (1 * \barwidth) * 0.5}

  \draw  (\barcenter, 3.5 * \stringheight) node {\ldots};

  \addtocounter{totalbarcount}{1}
  \stepcounter{barindex}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcounter{beatcount}
\newcounter{beatindex}

% length, beat count
\NewDocumentEnvironment{tabbar}{mm}{
  \setcounter{barcount}{#1}
  \setcounter{beatcount}{#2}
  \pgfmathsetmacro{\barstart}{\value{totalbarcount} * \barwidth}
  \pgfmathsetmacro{\barend}{(\value{totalbarcount} * \barwidth) + (#1 * \barwidth)}

  \foreach \row in {1,...,\tabrows}{
    \draw (\barstart, \row * \stringheight) -- (\barend, \row * \stringheight);
  };
  
  \barline
}{
  \barline
  \addtocounter{totalbarcount}{#1}
  \stepcounter{barindex}
  \setcounter{beatcount}{0}
  \setcounter{beatindex}{0}
}

\NewDocumentCommand{\tabbeat}{sm}{
  \stepcounter{beatindex}
  \pgfmathsetmacro{\beatend}{\barstart + ((\barwidth * \value{barcount}) / \value{beatcount} * \value{beatindex})}
  \pgfmathsetmacro{\beatcenter}{\beatend - \barwidth * \value{barcount} / \value{beatcount} * 0.5}
  \pgfmathsetmacro{\beatstart}{\beatend - \barwidth * \value{barcount} / \value{beatcount}}
  \readlist*\notelist{#2}

  \foreach \row in {1,...,\tabrows}{
    \pgfmathsetmacro{\stringY}{(\tabrows - \row + 1) * \stringheight}
    \itemtomacro\notelist[\row]\currnote
      \IfInteger{\currnote}{\draw (\beatcenter, \stringY) node[circle, fill=white, scale = 0.6, inner sep=1pt] {\IfBooleanTF{#1}{\currentchord[\row]}{\currnote}};}{}
  }

}

\NewDocumentCommand{\setchord}{m}{\readlist*\currentchord{#1}}

% (bar divisions, division index), name 
\NewDocumentCommand{\barcomment}{O{1,1}m}{
  \readlist*\commentposition{#1}

  \pgfmathsetmacro{\stepshift}{\barwidth * \value{barcount} / \commentposition[1]}
  \pgfmathsetmacro{\commentstart}{\barstart + (\stepshift * (\commentposition[2] - 0.5))}

  \draw (\commentstart, -\stringheight * 0.75) node {\footnotesize\writechord{#2}};
}

\NewDocumentCommand{\barline}{}{
  \pgfmathsetmacro{\beatend}{\barstart + ((\barwidth * \value{barcount}) / \value{beatcount} * (1 + \value{beatindex}))}
  \pgfmathsetmacro{\beatcenter}{\beatend - \barwidth * \value{barcount} / \value{beatcount} * 0.5}
    \pgfmathsetmacro{\beatstart}{\beatend - \barwidth * \value{barcount} / \value{beatcount}}
   \draw [thick] (\beatstart, \stringheight) -- (\beatstart, \tabrows * \stringheight);
}

\def\stringNames{{"e", "B", "G", "D", "A", "E"}}

\NewDocumentCommand{\tabstart}{}{
  \foreach \row in {1,...,\tabrows}{
    \draw (-\barwidth * 0.25, \row * \stringheight) node {\scriptsize\pgfmathparse{\stringNames[6 - \row ]}\pgfmathresult};
  };
}

\NewDocumentEnvironment{tab}{}{\vfill\begin{center}\usetikzlibrary{calc}\begin{optional}{tikzpicture}[scale=0.25, inner sep=0pt]\tabstart}{\setcounter{barindex}{0}\setcounter{totalbarcount}{0}\end{optional}\end{center}}

