
% TODO: move somewhere as well
\newcommand{\tallspace}{\vphantom{h}}

% TODO: move to appropriate file
\patchcmd{\chordboxenv}
  {\StrBehind{\pdflastmatch 0}{>}[\num]}% don't need that anymore
  {}{}{\errmessage{Oh no.}}
\patchcmd{\chordboxenv}
  {\ifnum\pdfmatch{^[0-9]+}{\fret}=1}
  {%
    \StrBefore{\fret:}{:}[\num]% we've got it here now anyway
    % could be x, could be a number, let's test it:
    \IfDecimal{\num}{\def\chordboxresult{1}}{\def\chordboxresult{0}}%
    \ifnum\chordboxresult=1
  }
  {}{\errmessage{Oh no.}}

%\renewcommand\tabularxcolumn[1]{p{#1}}% for vertical centering text in X column
\setlength\tabcolsep{0pt}
\renewcommand{\arraystretch}{0.75}

\NewDocumentCommand{\mysong}{mm+m}{%
  \phantomsection
  %\addcontentsline{toc}{subsection}{#1}
  \hspace{\leftpadding}
  \begin{tabularx}{\linewidth - \leftpadding - 0.5cm}{Xr} 
    \savecellbox{\fontsize{24}{24}\setmainfont{Larken Bold} #1%\hyperref[content]{#1}
    } & \savecellbox{\ifthenelse{\boolean{showchords}}{$\text{\footnotesize \shortstack[r]{#3} }$}{}} \\ [-\rowheight]
    %} & \savecellbox{\ifthenelse{\boolean{showchords}}{\footnotesize #3}{}} \\ [-\rowheight]
    \printcellmiddle & \multirow[t]{2}{*}{\printcelltop} \\
    %\fontsize{24}{24}\setmainfont{Larken Bold} #1 & \multirow[t]{2}{*}{\footnotesize #3} \\
    \ifblank{#2}{}{\small #2 & \\ }
  \end{tabularx}
}


\newcommand{\enablechords}{\setleadsheets{print-chords=true}}
\newcommand{\disablechords}{\setleadsheets{print-chords=false}}


\NewDocumentCommand{\enforcechords}{m}{\ifthenelse{#1}{\enablechords}{\disablechords}}

\NewDocumentCommand{\mchord}{sm}{%
    \enforcechords{\boolean{showchords}}\IfBooleanTF{#1}{\chord*{#2}\tallspace}{\chord{#2}\tallspace}}

\NewDocumentCommand{\ochord}{sm}{%
    \enforcechords{\boolean{showchords} \AND \boolean{showoptionalchords}}\IfBooleanTF{#1}{\chord*{#2}\tallspace}{\chord{#2}\tallspace}}


\NewDocumentCommand{\hchord}{sm}{%
  \disablechords\IfBooleanTF{#1}{\chord*{#2}\tallspace}{\chord{#2}\tallspace}}

\NewDocumentCommand{\ifchords}{mm}{%
  \ifthenelse{\boolean{showchords}}{#1}{#2}}


\NewDocumentCommand{\inlinechord}{m}{%
    \enablechords\writechord{#1}
}

\newcommand{\chordbreak}{\ifthenelse{\boolean{iscompact}}{}{\ifthenelse{\boolean{showchords}}{\pagebreak}{}}}

\newcommand{\compactbreak}{\ifthenelse{\boolean{iscompact}}{\pagebreak}{}}

\newcommand{\nochordbreak}{\ifthenelse{\boolean{showchords}}{}{\pagebreak}}

\RenewDocumentCommand{\capo}{m}{%
  \ifthenelse{\boolean{showchords}}{\hspace{\leftpadding}{Capo #1}}{}}

\NewDocumentCommand{\goto}{m}{%
  $\rightarrow$~~#1}


\NewDocumentCommand{\instruction}{m}{%
  ~~\textit{(#1)}}

\NewDocumentEnvironment{optional}{m +b}{%
  \ifthenelse{\boolean{showchords}}{\begin{#1}#2\end{#1}}{}}{}

\NewDocumentCommand{\solospace}{}{~~~}


